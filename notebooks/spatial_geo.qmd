---
title: "Agriculture processing"
format:
  html:
    code-fold: true
jupyter: python3
---

```{python}
from src.data.data_process import DataReg
from src.dao.zips_table import create_zips
from src.data.data_process import DataReg
from sqlmodel import create_engine
import geopandas as gpd
import pandas as pd
from sqlmodel import SQLModel
import ibis
from shapely.geometry import MultiPolygon, Polygon
import sqlite3

ibis.options.interactive = True
```

```{python}
engine = create_engine("postgresql://postgres:password@localhost:5432/postgres")
conn = ibis.postgres.connect(
  user="postgres",
  password="password",
  host="localhost",
  port="5432",
  database="postgres",
)
create_zips(engine)
```

```{python}
# create_zips(engine)
df = zips[["ZCTA5CE20", "geometry"]].rename(columns={"ZCTA5CE20":"zipcode"}).reset_index(drop=True)
conn.insert("ZipsTable")
```

```{python}
zips = gpd.read_file("data/external/zip_shape.zip", engine="pyogrio")
zips = zips[zips["ZCTA5CE20"].str.startswith("00")]
zips['geometry'] = zips['geometry'].apply(lambda geom: MultiPolygon([geom]) if isinstance(geom, Polygon) else geom)
df = zips[["ZCTA5CE20", "geometry"]].rename(columns={"ZCTA5CE20":"zipcode"}).reset_index(drop=True)
```

```{python}
conn.insert("zipstable", df)
```