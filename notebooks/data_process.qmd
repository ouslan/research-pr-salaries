---
title: "Agriculture processing"
format:
  html:
    code-fold: true
jupyter: python3
---

```{python}
import os
os.chdir("..")
```

```{python}
import pandas as pd
import ibis
from src.data.data_process import DataReg

ibis.options.interactive = True
```

```{python}
d = DataReg()
```

```{python}
df_qcew = d.conn.table("qcewtable")
df_qcew = df_qcew.filter(df_qcew.ein != "", df_qcew.phys_addr_5_zip!= "", df_qcew.year != "", df_qcew.qtr!= "")
df_qcew = df_qcew.cast({
  "first_month_employment": "float64", "second_month_employment": "float64", "third_month_employment": "float64",
  "year": "int32", "qtr": "int32", "total_wages": "float64"
  })
df_qcew = df_qcew.mutate(
  total_employment=(df_qcew.first_month_employment + df_qcew.second_month_employment + df_qcew.third_month_employment)/3
)
df_qcew = df_qcew.group_by(["year", "qtr", "ein", "phys_addr_5_zip"]).aggregate(
  [df_qcew.total_employment.sum().name("total_employment"), df_qcew.to]
  )
df_qcew = df_qcew.rename(zipcode="phys_addr_5_zip")
df_qcew
```

```{python}
df_qcew = d.conn.table("qcewtable")
df_qcew = df_qcew.filter(
  df_qcew.ein != "",
  df_qcew.phys_addr_5_zip!= "",
  df_qcew.qtr != "",
  df_qcew.first_month_employment != "" 
)
df_qcew = df_qcew.cast({
  "first_month_employment": "float64", "second_month_employment": "float64", "third_month_employment": "float64",
  "year": "int32", "qtr": "int32", "total_wages": "float64"
  })
df_qcew = df_qcew.mutate(
  total_employment=(df_qcew.first_month_employment + df_qcew.second_month_employment + df_qcew.third_month_employment)/3
)
df_qcew = df_qcew.group_by(["year", "qtr", "ein", "phys_addr_5_zip"]).aggregate(
  [df_qcew.total_employment.sum().name("total_employment"), df_qcew.to]
  )
df_qcew = df_qcew.rename(zipcode="phys_addr_5_zip")
df_qcew
```

```{python}
df_dp03 = d.conn.table("dp03table")
df_qcew.join(df_dp03, predicates=["year", "qtr", "zipcode"], how="inner")
```